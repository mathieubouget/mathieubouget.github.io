<!DOCTYPE html>
<html>
	<head>
		<title>Pierre Feuille Ciseaux</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="http://localhost/~mathieubouget/.serv/css/style.css"/>
		<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
.hide {
	display: none;
}
					#score_div {
						float: right;
						font-size : 4em;
					padding-left: 10px;
						margin: 0;
					}
					#score_div h3 {
						margin: 0;
					}
</style>
	</head>
	<body>
		<header>
			<h1>Pierre Feuille Ciseaux</h1>
		</header>
		<aside>
			<ul>
				<li><a href="#">Pierrefeuille</a></li>
			</ul>
		</aside>
		<section>
			<h2>Bienvenue</h2>
			<p>
				Salut à toi jeune sanctionneur !
				<button id="connect_button">Connexion</button>
				<span id="error"></span>
				<div id="interface" class="hide">
					<hr>
					<button id="joinGame">Rejoindre la partie</button>
					<button id="refresh">Rafraîchir les informations</button>
					<div id="score_div">	
						<h3><span  id="score1"></span> - <span id="score2"></span></h3>
					</div>
					<hr>
					Joueur 1 : <span id="player1"></span> <br> Joueur 2 : <span id="player2"></span>
					<hr>
					<label for="code">Code secret à changer entre chaque tour : </label>
					<input id="code">
					<label for="pierre" style="display: block;">Pierre
					<input name="played"  type="radio" id="pierre" value="1" checked></label>
					<label for="feuille" style="display: block;">Feuille
					<input name="played"  type="radio" id="feuille" value="2"></label>
					<label for="Ciseaux" style="display: block;">Ciseaux
					<input name="played"  type="radio" id="Ciseaux" value="3"></label>
					<button id="sendHash">sendHash</button>
					<button id="reveal">envoyer en clair</button>
					<hr>
					<span id="state"></span>
					<span id="winner"></span>
				</div>
			</p>
		</section>
		<footer>
			Site web édité par Mathieu Bouget
		</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.9/web3.min.js"
			integrity="sha512-nSsbf+0JUKJcrIndy9WcqqmOyeor0ALDBgv/kGWnjdshnnN3ciBxX8FewTPdChsVC5pRyggbkjSCyOLU3PxDkA==" crossorigin="anonymous"
		referrerpolicy="no-referrer"></script>
		<script type="text/javascript">
			window.addEventListener('load', function() {

				var cbutton = document.getElementById("connect_button");
				var errorzone = document.getElementById("error");
				if (typeof ethereum !== 'undefined') {

					window.web3js = new Web3(window.ethereum);
					//web3js = new Web3(web3.currentProvider);

					ethereum.on('chainChanged', (chainId) => {
            			window.location.reload();
        			});

					ethereum.on('accountsChanged', (accounts) => {
						window.location.reload();
					});

					function startApp(){

						console.log("StartApp")
									const abi = [
			{
				"inputs": [],
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"inputs": [],
				"name": "hash1",
				"outputs": [
					{
						"internalType": "bytes32",
						"name": "",
						"type": "bytes32"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "hash2",
				"outputs": [
					{
						"internalType": "bytes32",
						"name": "",
						"type": "bytes32"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "joinGame",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "maxscore",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "player1",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "player2",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "rev1",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "rev2",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "played",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "code",
						"type": "uint256"
					}
				],
				"name": "reveal",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "score1",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "score2",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "bytes32",
						"name": "hash",
						"type": "bytes32"
					}
				],
				"name": "sendHash",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "state",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "winner",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			}
		];

						const contractaddress = '0x8cbd2580c7e530cb1127441c4e4748f31d1ed100';
						const contract = new window.web3js.eth.Contract(abi,contractaddress);
						document.getElementById('interface').classList.remove('hide');

						document.getElementById('joinGame').onclick = function(){

        contract.methods.joinGame ()
        .send( {from: ethereum.selectedAddress}).then( function(tx) {
            console.log(tx);
        });

						}

						document.getElementById('refresh').onclick = function(){
										contract.methods.score1().call({from: ethereum.selectedAddress}).then( function(tx) {
														console.log(tx)
														document.getElementById('score1').textContent = tx
													})
										contract.methods.score2().call({from: ethereum.selectedAddress}).then( function(tx) {
														console.log(tx)
														document.getElementById('score2').textContent = tx
													})
										
										contract.methods.state().call({from: ethereum.selectedAddress}).then( function(tx) {
														console.log(tx)
														var res = "";
														if (tx == 0) {
																	res = "Les deux joueurs ne sont pas encore dans la partie";
																	} else if (tx == 1|| tx == 2 || tx ==3) {
																				res = "Vous et votre adversaire devez envoyer votre réponse sous forme de hash."
																				}
														else if (tx == 4 || tx ==5 || tx ==6) {
																		res = "Vous et votre adversaire devez envoyer votre réponse en clair.";
																	} else if (tx == 7) {
																					res = "La partie est terminée, le gagant est : ";
																					document.getElementById("winner").classList.remove("hide");
																				}
														document.getElementById('state').textContent = "("+tx+") "+res;
													})
										contract.methods.winner().call({from: ethereum.selectedAddress}).then( function(tx) {
														console.log(tx)
												document.getElementById("winner").textContent = tx;
													})
										contract.methods.player1().call({from: ethereum.selectedAddress}).then( function(tx) {
														document.getElementById("player1").textContent = tx;
													})
										contract.methods.player2().call({from: ethereum.selectedAddress}).then( function(tx) {
														document.getElementById("player2").textContent = tx;
													})
									}
					document.getElementById('sendHash').onclick = function(){
									var code = document.getElementById('code').value;
									var played = document.querySelector('input[name="played"]:checked').value;
									var hash = window.web3js.utils.soliditySha3({t: 'uint256',
													v: played},{t: 'uint256', v: code});
									console.log(hash)
									contract.methods.sendHash(hash).send({from: ethereum.selectedAddress});
								}
					document.getElementById('reveal').onclick = function(){
									var code = document.getElementById('code').value;
									var played = document.querySelector('input[name="played"]:checked').value;
									contract.methods.reveal(played,code).send({from: ethereum.selectedAddress});
								}

						// insérer code javascript ici pour interragir avec le contrat
					}

					cbutton.onclick = function(){
						console.log(ethereum);
						//const accounts = ethereum.request({ method: 'eth_accounts' });
						ethereum.request({method: 'eth_requestAccounts'}).then(function (res) {
							console.log(res);
							if(ethereum.chainId === '0x3'){
								cbutton.classList.add('hide')
								startApp();
							} else {
								errorzone.textContent = "no matching chainid";
							}
						});
        			};
				} else {
					errorzone.textContent = "No wallet"
					cbutton.classList.add('hide');
				}
			})
		</script>
	</body>
</html>
