<!DOCTYPE html>
<html>
	<head>
		<title>Serveur Local</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="../css/style.css"/>
	</head>
	<body>
		<header>
			<h1>Serveur local</h1>
		</header>
		<aside>
			<ul>
				<li><a href="../">Accueil</a></li>
				<ul>
					<li><a href="index.html?contract=sanction">Sanction</a></li>
					<li><a href="index.html?contract=cryptopixelv1">CryptoPixel v1.0</a></li>
					<li><a href="index.html?contract=pixelv2.1">CryptoPixel v1.0</a></li>
				</ul>
			</ul>
		</aside>
		<section>
			<h1>Interraction avec un smart contract</h1>
			<p>
				Aide pour interagir avec les contrats
				<ul>
					<li><a href="https://metamask.io/download.html" target="_blank">Installer Metamask</a></li>
					<li><a href="https://docs.fantom.foundation/tutorials/set-up-metamask-testnet" target="_blank">
						Configurer le testnet fantom sur MetaMask</a></li>
					<li><a href="https://faucet.fantom.network/" target="_blank">Récupérer gratuitement du FTM sur le testnet</a></li>
				</ul>
			</p>
			<hr>
			<div id="connexion">
				<div id="error" class="error"></div>
				<button id="connectbutton">Connexion au portefeuille</button>
			</div>
			<hr>
			<div id="contracthtml"></div>
		</section>
		<footer>
			Site web édité par <a href="https://www.mathraining.be/users/1446" target="_blank">Mathieu Bouget</a>
		</footer>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
		<script type="text/javascript" src="../js/loadScript.js"></script>
		<script>
			function $_GET(param) {
				var vars = {};
				window.location.href.replace( location.hash, '' ).replace( 
					/[?&]+([^=&]+)=?([^&]*)?/gi, // regexp
					function( m, key, value ) { // callback
						vars[key] = value !== undefined ? value : '';
					}
				);
				if ( param ) {
					return vars[param] ? vars[param] : null;	
				}
				return vars;
			}
			function startApp(contract){
				$("#contracthtml").load(contract+'/index.html',function(){
					var chainId = $("#chainId").text();
					var contractaddress = $("#address").text();
					console.log(contractaddress);
					console.log(chainId);
					if(chainId==ethereum.chainId){
						$("#error").hide();
						var scriptUrl = contract+'/index.js';
						var scriptOptions = {
							parentTag: document.body,
							callback: function() {
								$.getJSON(contract+'/abi.json', function(abi) {
									var contract = new window.web3js.eth.Contract(abi,contractaddress);
									startContract(contract)
									console.log("contrat démarré")
								});
							}
						};
						loadScript(scriptUrl, scriptOptions);
					} else  if (chaidId){
						$("#error").text("Portefeuille connecté à la mauvaise blockchain, il faut choisir celle d'Id "+chainId+".");
						$("#contracthtml").hide();
					}
				});
			}
			window.addEventListener('load', function() {
				if (typeof window.ethereum !== 'undefined') {
					window.web3js = new Web3(window.ethereum);
					ethereum.on('chainChanged', (chainId) => {
            			window.location.reload();
        			});
					ethereum.on('accountsChanged', (accounts) => {
						window.location.reload();
					});
					$("#connectbutton").on('click', function(){
						ethereum.request({method: 'eth_requestAccounts'}).then(function (res) {
							$("#connectbutton").hide();
							if($_GET("contract")){
								$("#error").text("Contrat inexistant, veuillez en choisir un dans le menu à côté.")
								startApp($_GET("contract"));
							} else {
								$("#error").text("Aucun contrat définit, veuillez en choisir un dans le menu à côté.")
							}
						});
        			});
				} else {
					$("#error").text("Aucun portefeuille détecté dans votre navigateur, vous ne pouvez pas interagir avec le contrat.");
					$("#connectbutton").hide();
				}
			})	
		</script>
	</body>
</html>
